<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Web-Vergleich – Analyse</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color:#111; }
    h1 { margin: 0 0 8px; }
    .subtitle{ color:#555; margin-bottom:16px; }
    .card{ border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:16px 0; }
    .row{ display:flex; flex-wrap:wrap; gap:16px; }
    .col{ flex:1 1 360px; min-width:320px; }
    .chart-title{ font-weight:600; margin:8px 0 4px; }
    .chart-subtitle{ color:#6b7280; margin-bottom:8px; }
    .legend{ margin-top:8px; display:grid; grid-template-columns:1fr 1fr; gap:6px 12px; }
    .legend-item{ display:flex; align-items:center; gap:8px; font-size:14px; }
    .legend-color{ width:12px; height:12px; border-radius:2px; background:#ddd; }
    .muted{ color:#6b7280; }
    .uploader{ display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    button{ padding:8px 12px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    canvas{ max-width:100%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>Web-Vergleich – Analyse</h1>
  <div class="subtitle">Lade eine Excel-Datei hoch (Original-Export oder die verarbeitete Datei), um die Produktanalyse zu sehen.</div>

  <div class="card">
    <div class="uploader">
      <input id="fileInput" type="file" accept=".xlsx,.xls" />
      <button id="analyzeBtn">Analysieren</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="row">
      <div class="col">
        <div class="chart-title">Schritt 1 – Produktanalyse</div>
        <div class="chart-subtitle" id="step1Subtitle">Alle Produkte vs. Siemens-Produkte</div>
        <canvas id="productsChart" height="220"></canvas>
        <div class="legend" id="productsLegend"></div>
      </div>

      <div class="col">
        <div class="chart-title">Schritt 2 – Web-Suche</div>
        <div class="chart-subtitle" id="step2Subtitle">Gesuchte Werte insgesamt</div>
        <canvas id="searchChart" height="220"></canvas>
        <div class="legend" id="searchLegend"></div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="chart-title">Schritt 3 – Übereinstimmung vs. Abweichung</div>
        <div class="chart-subtitle">Anteil der gefundenen Web-Werte</div>
        <canvas id="matchChart" height="220"></canvas>
        <div class="legend" id="matchLegend"></div>
      </div>
    </div>
  </div>

<script>
/* ===== Center-Text Plugin für Doughnuts ===== */
const centerTextPlugin = {
  id: 'centerTextPlugin',
  beforeDraw(chart, args, opts) {
    if (!opts || !opts.text) return;
    const { ctx, chartArea: { width, height } } = chart;
    ctx.save();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = (opts.font || '600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif');
    ctx.fillStyle = (opts.color || '#111');
    ctx.fillText(opts.text, width / 2, height / 2);
    ctx.restore();
  }
};
Chart.register(centerTextPlugin);

let productsChart, searchChart, matchChart;

function makeDonut(el, data, labels, centerText) {
  return new Chart(el, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data }]
    },
    options: {
      responsive: true,
      cutout: '64%',
      plugins: {
        legend: { display: false },
        centerTextPlugin: centerText ? { text: centerText } : undefined,
        tooltip: { enabled: true }
      }
    }
  });
}
function makeBar(el, labels, data) {
  return new Chart(el, {
    type: 'bar',
    data: {
      labels,
      datasets: [{ data }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { enabled: true } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
}

function updateProductsChart(totalProducts, totalSiemens) {
  const other = Math.max(0, totalProducts - totalSiemens);
  const ctx = document.getElementById('productsChart').getContext('2d');
  if (productsChart) productsChart.destroy();
  productsChart = makeDonut(ctx, [totalSiemens, other], ['Siemens', 'Andere'], null);

  document.getElementById('step1Subtitle').textContent =
    `Gesamtdatensatz: ${totalProducts} • Siemens: ${totalSiemens} • Andere: ${other}`;

  document.getElementById('productsLegend').innerHTML = `
    <div class="legend-item"><div class="legend-color" style="background:rgba(59,130,246,.8)"></div><span>Siemens-Produkte: ${totalSiemens}</span></div>
    <div class="legend-item"><div class="legend-color" style="background:rgba(191,191,191,.8)"></div><span>Andere Produkte: ${other}</span></div>
  `;
}

function updateSearchChart(searchedValues, foundWebValues) {
  const missing = Math.max(0, searchedValues - foundWebValues);
  const ctx = document.getElementById('searchChart').getContext('2d');
  if (searchChart) searchChart.destroy();
  searchChart = makeDonut(ctx, [foundWebValues, missing], ['Gefunden', 'Fehlend'],
    `Gesamt: ${searchedValues}`);

  document.getElementById('step2Subtitle').textContent = `Gesuchte Werte insgesamt: ${searchedValues}`;
  document.getElementById('searchLegend').innerHTML = `
    <div class="legend-item"><div class="legend-color" style="background:rgba(34,197,94,.8)"></div><span>Gefunden: ${foundWebValues}</span></div>
    <div class="legend-item"><div class="legend-color" style="background:rgba(249,115,22,.8)"></div><span>Fehlend: ${missing}</span></div>
  `;
}

function updateMatchChart(green, red) {
  const ctx = document.getElementById('matchChart').getContext('2d');
  if (matchChart) matchChart.destroy();
  matchChart = makeBar(ctx, ['Übereinstimmung (grün)', 'Abweichung (rot)'], [green, red]);
  document.getElementById('matchLegend').innerHTML = `
    <div class="legend-item"><div class="legend-color" style="background:rgba(16,185,129,.8)"></div><span>Grün: ${green}</span></div>
    <div class="legend-item"><div class="legend-color" style="background:rgba(239,68,68,.8)"></div><span>Rot: ${red}</span></div>
  `;
}

async function postExcel(url, file) {
  const fd = new FormData();
  fd.append('file', file);
  const resp = await fetch(url, { method:'POST', body: fd });
  if (!resp.ok) throw new Error((await resp.json()).error || 'Fehler');
  return resp.json();
}

document.getElementById('analyzeBtn').addEventListener('click', async () => {
  const file = document.getElementById('fileInput').files[0];
  const status = document.getElementById('status');
  if (!file) { status.textContent = 'Bitte Datei wählen.'; return; }
  status.textContent = 'Analyse läuft…';

  try {
    const stats = await postExcel('/api/web-search-stats', file);
    // Schritt 1
    updateProductsChart(stats.totalProducts || 0, stats.totalSiemens || 0);
    // Schritt 2
    updateSearchChart(stats.searchedValues || 0, stats.foundWebValues || 0);
    // Schritt 3
    updateMatchChart(stats.green || 0, stats.red || 0);
    status.textContent = 'Fertig.';
  } catch (e) {
    status.textContent = 'Fehler: ' + (e?.message || e);
  }
});
</script>
</body>
</html>
