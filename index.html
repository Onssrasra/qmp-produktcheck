<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DB Produktdaten — Qualitätsmonitor</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root {
      --db-red: #c20015;
      --db-red-dark: #a00012;
      --grey-1: #f5f5f5;
      --grey-2: #e6e6e6;
      --grey-3: #bfbfbf;
      --grey-4: #8c8c8c;
      --text: #222;
      --white: #ffffff;
      --black: #000000;
      --green: #22c55e;
      --orange: #f97316;
      --blue: #3b82f6;
      --light-green: #86efac;
      --light-red: #fca5a5;
      --light-orange: #fed7aa;
      --light-blue: #93c5fd;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--white);
      color: var(--text);
      min-height: 100vh;
      padding: 10px 0;
    }
    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header mit Logos */
    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--white);
      padding: 0;
      margin-bottom: 25px;
      box-shadow: none;
      border: none;
    }

    .logo-left, .logo-right {
      flex: 0 0 auto;
      width: 120px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-logo {
      height: 60px;
      width: auto;
      max-width: 110px;
      object-fit: contain;
    }

    .header-title {
      flex: 1;
      text-align: center;
      padding: 0 30px;
    }

    .header-title h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 700;
      color: #911e16;
    }

    .header-title p {
      margin: 0;
      font-size: 14px;
      color: var(--grey-4);
      font-weight: 500;
      line-height: 1.4;
    }
    
    /* Divider */
    .divider {
      width: 100%;
      height: 3px;
      background: var(--db-red);
      border-radius: 2px;
      margin: 25px 0;
    }
   
    /* SVG Icons */
    .section-icon {
      width: 20px;
      height: 20px;
      margin-right: 8px;
      vertical-align: middle;
      color: var(--black);
      stroke: currentColor;
      stroke-width: 2;
    }
    
    .dropzone-icon svg {
      width: 48px;
      height: 48px;
      color: var(--grey-4);
      stroke: currentColor;
      stroke-width: 2;
    }
    
    /* Card Design */
    .card {
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 30px;
      border: 1px solid var(--grey-2);
      margin-bottom: 20px;
    }
    
    /* Dropzone */
    .dropzone {
      border: 2px dashed var(--grey-3);
      border-radius: 10px;
      padding: 20px 15px;
      background: var(--grey-1);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      user-select: none;
      position: relative;
      overflow: hidden;
      margin: 0 auto 20px auto;
      min-height: 100px;
      max-width: 500px;
    }
    
    .dropzone.dragover {
      border-color: #911e16;
      background: var(--white);
      transform: scale(1.02);
      box-shadow: 0 8px 32px rgba(145, 30, 22, 0.15);
    }
    
    .dropzone strong { font-size: 14px; font-weight: 600; color: var(--text); }
    .hint { font-size: 12px; color: var(--grey-4); margin-top: 4px; }
    .dropzone-icon { font-size: 24px; color: var(--grey-4); margin-bottom: 4px; }
    .dropzone-text { text-align: center; margin: 0; padding: 20px; }
    
    #action-choices {
      display: none;
      gap: 30px;
      align-items: flex-start;
      transition: all 0.4s ease-in-out;
    }

    /* CHANGED: Simplified stacked layout with fixed order */
    #action-choices.stacked {
      flex-direction: column;
      gap: 25px;
    }
    #action-choices.stacked #quality-section {
      order: 1; /* Always on top */
    }
    #action-choices.stacked #web-search-section {
      order: 2; /* Always at bottom */
    }
    
    .action-section {
      margin-bottom: 25px;
      transition: opacity 0.4s ease-in-out;
    }
    
    #action-choices .action-section {
      flex: 1;
      width: 100%;
      border: 1px solid var(--grey-2);
      padding: 25px;
      border-radius: 12px;
      background-color: #fdfdfd;
      margin-bottom: 0;
    }

    .action-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Buttons */
    button {
      min-width: 160px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 10px;
      border: 2px solid #911e16;
      background: #911e16;
      color: var(--white);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover:not(:disabled) {
      background: #7a1914;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(145, 30, 22, 0.3);
    }
    
    button.secondary { background: var(--white); color: #911e16; border-color: #911e16; }
    button.secondary:hover:not(:disabled) { background: #f9f9f9; box-shadow: 0 8px 24px rgba(145, 30, 22, 0.15); }
    button.success { background: var(--green); border-color: var(--green); color: var(--white); }
    button.success:hover:not(:disabled) { background: #16a34a; border-color: #16a34a; box-shadow: 0 8px 24px rgba(22, 163, 74, 0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; background: #911e16; color: var(--white); border-color: #911e16; }
    button.secondary:disabled { background: var(--white); color: #911e16; border-color: #911e16; }

    /* Charts Container */
    .charts-container {
      margin: 20px 0;
      padding: 20px;
      background: var(--grey-1);
      border-radius: 12px;
      border: 1px solid var(--grey-2);
    }

    .charts-container.hidden { display: none; }

    #qualityCharts {
      margin: 20px 0;
      padding: 15px 20px;
      background: var(--grey-1);
      border-radius: 12px;
      border: 1px solid var(--grey-2);
      flex-direction: column;
      align-items: center;
      min-height: auto;
    }

    #qualityCharts:not(.hidden) { display: flex; }
    
    .charts-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
      text-align: center;
    }

    .quality-chart {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
    }

    /* CHANGED: Made quality chart more compact */
    .chart-wrapper {
      position: relative;
      width: 450px;
      height: 450px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Ring Charts */
    .ring-charts-container {
      display: flex;
      justify-content: space-between;
      align-items: stretch;
      gap: 20px;
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
      flex-wrap: nowrap;
    }

    .ring-chart-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      background: var(--white);
      border: 1px solid var(--grey-2);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      height: 750px;
      box-sizing: border-box;
    }

    .ring-chart-group:first-child { flex: 2; }
    .ring-chart-group:last-child { flex: 1; }

    .ring-chart-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 500px;
      height: 500px;
      flex-shrink: 0;
    }

    .ring-chart-wrapper svg { display: block; margin: 0 auto; }
    #concentricChart, #ampelRingChart { width: 500px; height: 500px; }

    /* SVG Ring Styles */
    .ring-segment { cursor: pointer; transition: opacity 0.2s ease; }
    .ring-segment:hover { opacity: 0.8; }
    .center-text { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; text-anchor: middle; dominant-baseline: middle; fill: var(--text); }
    .center-text-title { font-size: 10px; font-weight: 600; }
    .center-text-value { font-size: 14px; font-weight: 700; }

    /* Tooltip */
    .chart-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    /* Legend */
    .custom-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 10px;
      font-size: 14px;
    }

    .chart-legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 20px;
      font-size: 12px;
      text-align: center;
      min-height: 120px;
      justify-content: flex-start;
      width: 100%;
      padding: 0 10px;
      box-sizing: border-box;
    }

    .legend-item { display: flex; align-items: center; justify-content: center; gap: 6px; }
    .legend-color { width: 12px; height: 12px; border-radius: 2px; }

    /* Status & Progress */
    .status {
      margin-top: 20px;
      min-height: 20px;
      font-size: 14px;
      color: var(--text);
      text-align: center;
      font-weight: 500;
    }
    
    .progress {
      width: 100%;
      height: 6px;
      background: var(--grey-2);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 12px;
      display: none;
    }
    
    .progress > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #911e16, #7a1914);
      transition: width 0.3s ease;
      border-radius: 999px;
    }

    .hidden { display: none; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .wrap { padding: 0 15px; }
      .card { padding: 20px; }
      #action-choices,
      #action-choices.stacked {
        flex-direction: column;
        gap: 20px;
      }
      .chart-wrapper {
        width: 320px;
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="main-header">
        <div class="logo-left">
          <img src="/Images/Deutsche_Bahn_AG-Logo.svg.png" alt="Deutsche Bahn Logo" class="header-logo">
        </div>
        <div class="header-title">
          <h1>Qualitätsmonitor für Materialstammdaten</h1>
          <p>Prüfung von Vollständigkeit & Plausibilität und Vergleich mit Siemens-Webdaten (MyMobase)</p>
        </div>
        <div class="logo-right">
          <img src="/Images/TU-Berlin-Logo.svg.png" alt="TU Berlin Logo" class="header-logo">
        </div>
      </div>

      <div class="divider"></div>

      <div class="action-section" id="upload-section">
        <h3>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="section-icon">
            <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
            <path d="M2 10h20"/>
          </svg>
          Schritt 1: Datei hochladen
        </h3>
        <center>
          <div id="dropzone" class="dropzone">
            <div class="dropzone-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
                <path d="M2 10h20"/>
              </svg>
            </div>
            <p id="dzText" class="dropzone-text">
              <strong>Datei hier ablegen</strong><br>
              oder klicken zum Auswählen
            </p>
            <p class="hint">Unterstützt .xlsx und .xls Dateien (max. 10 MB)</p>
          </div>
        </center>
        <input type="file" id="fileInput" accept=".xlsx,.xls" hidden />
      </div>

      <div id="action-choices">
        <div class="action-section" id="quality-section">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="section-icon">
              <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
              <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
              <path d="m9 14 2 2 4-4"/>
            </svg>
            Option A: Vollständigkeit prüfen
          </h3>
          <div class="action-buttons">
            <button id="qualityCheckBtn" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Prüfung starten
            </button>
            <button id="downloadQualityBtn" class="secondary" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
              Bericht herunterladen
            </button>
          </div>
          
          <div id="qualityCharts" class="charts-container hidden">
            <div class="charts-title">Ergebnis der Qualitätsprüfung</div>
            <div class="quality-chart">
              <div class="chart-wrapper">
                <svg id="qualityChart" width="450" height="450"></svg>
              </div>
            </div>
            <div class="custom-legend" id="qualityLegend"></div>
          </div>
        </div>

        <div class="action-section" id="web-search-section">
          <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="section-icon">
              <path d="m21 21-4.34-4.34"/>
              <circle cx="11" cy="11" r="8"/>
            </svg>
            Option B: Web-Vergleich (Siemens)
          </h3>
          <div class="action-buttons">
            <button id="webSearchBtn" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Suche starten
            </button>
            <button id="downloadWebBtn" class="secondary" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
              Ergebnis herunterladen
            </button>
          </div>
          
          <div id="webCharts" class="charts-container hidden">
            <div class="ring-charts-container">
              <div class="ring-chart-group">
                <div class="chart-title">Web-Suche Ergebnisse für Siemens Produkte</div>
                <div class="ring-chart-wrapper">
                  <svg id="concentricChart" width="500" height="500"></svg>
                </div>
                <div class="chart-legend" id="concentricLegend"></div>
              </div>
              <div class="ring-chart-group">
                <div class="chart-title">Siemens-Produkte nach Datenaktualität</div>
                <div class="ring-chart-wrapper">
                  <svg id="ampelRingChart" width="500" height="500"></svg>
                </div>
                <div class="chart-legend" id="ampelRingLegend"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="status" id="status"></div>
      <div class="progress" id="progress"><div></div></div>
    </div>
  </div>

  <script>
    /* ==================== VARIABLEN ==================== */
    const dropzone = document.getElementById('dropzone');
    const dzText = document.getElementById('dzText');
    const fileInput = document.getElementById('fileInput');
    
    const webSearchBtn = document.getElementById('webSearchBtn');
    const downloadWebBtn = document.getElementById('downloadWebBtn');
    const qualityCheckBtn = document.getElementById('qualityCheckBtn');
    const downloadQualityBtn = document.getElementById('downloadQualityBtn');
    
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const bar = progressEl.firstElementChild;
    
    const actionChoices = document.getElementById('action-choices');
    
    const qualityCharts = document.getElementById('qualityCharts');
    const webCharts = document.getElementById('webCharts');
    
    let selectedFile = null;
    let webProcessedBlob = null;
    let qualityBlob = null;
    let qualityStats = null;

    /* ==================== HELPER FUNCTIONS ==================== */
    
    function resetAllStates() {
      qualityBlob = null;
      webProcessedBlob = null;
      qualityStats = null;
      
      const concentricChart = document.getElementById('concentricChart');
      const ampelRingChart = document.getElementById('ampelRingChart');
      if (concentricChart) concentricChart.innerHTML = '';
      if (ampelRingChart) ampelRingChart.innerHTML = '';
      
      const tooltips = document.querySelectorAll('.chart-tooltip');
      tooltips.forEach(tooltip => tooltip.remove());
      
      downloadQualityBtn.disabled = true;
      downloadWebBtn.disabled = true;
      downloadQualityBtn.classList.add('secondary');
      downloadQualityBtn.classList.remove('success');
      downloadWebBtn.classList.add('secondary');
      downloadWebBtn.classList.remove('success');

      qualityCheckBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Prüfung starten`;
      webSearchBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-play"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Suche starten`;
      
      qualityCharts.classList.add('hidden');
      webCharts.classList.add('hidden');
      
      document.getElementById('qualityLegend').innerHTML = '';
      document.getElementById('concentricLegend').innerHTML = '';
      document.getElementById('ampelRingLegend').innerHTML = '';
      
      // CHANGED: Reset layout class
      actionChoices.classList.remove('stacked');
      
      statusEl.textContent = 'Bereit für neue Datei';
    }

    function showProgress(show = true) {
      progressEl.style.display = show ? 'block' : 'none';
      if (!show) bar.style.width = '0%';
    }

    function updateProgress(percent) {
      bar.style.width = percent + '%';
    }

    /* ==================== CHART FUNCTIONS (abbreviated for brevity) ==================== */
    function createQualityChart(complete, incomplete, total) { const svg = document.getElementById('qualityChart'); svg.innerHTML = ''; const centerX = 225, centerY = 225; const colors = { complete: '#22c55e', incomplete: '#c20015' }; const completePercent = total > 0 ? (complete / total) * 100 : 0; const startAngle = -Math.PI / 2; const completeAngle = startAngle + (completePercent / 100) * 2 * Math.PI; const tooltip = createTooltip(); svg.parentElement.appendChild(tooltip); const centerTexts = ['Gesamtdatensätze*', total.toString()]; const centerRadius = calculateCenterCircleRadius(centerTexts, 65); const ringThickness = 50, innerRadius = centerRadius + 15, outerRadius = innerRadius + ringThickness; createRingSegment(svg, centerX, centerY, innerRadius, outerRadius, startAngle, completeAngle, colors.complete, `Vollständig & richtig: ${complete} (${completePercent.toFixed(1)}%)`, tooltip); createRingSegment(svg, centerX, centerY, innerRadius, outerRadius, completeAngle, startAngle + 2 * Math.PI, colors.incomplete, `Unvollständig/unplausibel: ${incomplete} (${(100 - completePercent).toFixed(1)}%)`, tooltip); createCentralCircle(svg, centerX, centerY, centerRadius, total, 'Datensätze'); const legendContainer = document.getElementById('qualityLegend'); legendContainer.innerHTML = `<div style="position: relative; width: 100%;"><div style="display: flex; justify-content: center; align-items: center; flex-direction: column;"><div class="legend-item" style="margin-bottom: 8px;"><div class="legend-color" style="background-color: #22c55e;"></div><span>Vollständig & plausibel: ${complete} (${completePercent.toFixed(1)}%)</span></div><div class="legend-item"><div class="legend-color" style="background-color: #c20015;"></div><span>Unvollständig & unplausibel: ${incomplete} (${(100 - completePercent).toFixed(1)}%)</span></div></div><div style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 12px; color: var(--grey-4); font-style: italic; white-space: nowrap;">*Datensatz = Materialnummer</div></div>`; }
    function createWebCharts(stats) { createConcentricRingChart(stats); createAmpelRingChart(stats.ampelGreen || 0, stats.ampelRed || 0); createConcentricLegend(stats); createAmpelRingLegend(stats.ampelGreen || 0, stats.ampelRed || 0); }
    function createConcentricRingChart(stats) { const svg = document.getElementById('concentricChart'); svg.innerHTML = ''; const centerX = 250, centerY = 250; const colors = { siemens: '#4A90E2', andere: '#E5E7EB', gefunden: '#27AE60', fehlend: '#E74C3C', uebereinstimmungen: '#2ECC71', abweichungen: '#C0392B' }; const siemensPercent = stats.totalDataSets > 0 ? (stats.totalSiemens / stats.totalDataSets) * 100 : 0; const webFoundPercent = stats.searchedValues > 0 ? (stats.foundWebValues / stats.searchedValues) * 100 : 0; const matchesPercent = stats.foundWebValues > 0 ? (stats.green / stats.foundWebValues) * 100 : 0; const startAngle = -Math.PI / 2; const siemensAngle = startAngle + (siemensPercent / 100) * 2 * Math.PI; const webFoundAngle = startAngle + (webFoundPercent / 100) * (siemensAngle - startAngle); const matchesAngle = startAngle + (matchesPercent / 100) * (webFoundAngle - startAngle); const tooltip = createTooltip(); svg.parentElement.appendChild(tooltip); const centerTexts = ['Gesamtdatensätze', stats.totalDataSets.toString()]; const centerRadius = calculateCenterCircleRadius(centerTexts, 65); const ringThickness = 35; const ring1Inner = centerRadius + 10, ring1Outer = ring1Inner + ringThickness; const ring2Inner = ring1Outer + 8, ring2Outer = ring2Inner + ringThickness; const ring3Inner = ring2Outer + 8, ring3Outer = ring3Inner + ringThickness; createRingSegment(svg, centerX, centerY, ring1Inner, ring1Outer, startAngle, siemensAngle, colors.siemens, `Siemensprodukte: ${stats.totalSiemens} (${siemensPercent.toFixed(1)}%)`, tooltip); createRingSegment(svg, centerX, centerY, ring1Inner, ring1Outer, siemensAngle, startAngle + 2 * Math.PI, colors.andere, `Produkte anderer Hersteller: ${stats.totalDataSets - stats.totalSiemens} (${(100 - siemensPercent).toFixed(1)}%)`, tooltip); const webFoundAngleEnd = webFoundAngle; const webMissingAngleEnd = siemensAngle; createRingSegment(svg, centerX, centerY, ring2Inner, ring2Outer, startAngle, webFoundAngleEnd, colors.gefunden, `Gefundene Web-Werte: ${stats.foundWebValues} (${webFoundPercent.toFixed(1)}%)`, tooltip); createRingSegment(svg, centerX, centerY, ring2Inner, ring2Outer, webFoundAngleEnd, webMissingAngleEnd, colors.fehlend, `Fehlende Web-Werte: ${stats.searchedValues - stats.foundWebValues} (${(100 - webFoundPercent).toFixed(1)}%)`, tooltip); createRingSegment(svg, centerX, centerY, ring3Inner, ring3Outer, startAngle, matchesAngle, colors.uebereinstimmungen, `Übereinstimmungen: ${stats.green} (${matchesPercent.toFixed(1)}%)`, tooltip); createRingSegment(svg, centerX, centerY, ring3Inner, ring3Outer, matchesAngle, webFoundAngleEnd, colors.abweichungen, `Abweichungen: ${stats.red} (${(100 - matchesPercent).toFixed(1)}%)`, tooltip); createCentralCircle(svg, centerX, centerY, centerRadius, stats.totalDataSets); }
    function createAmpelRingChart(greenProducts, redProducts) { const svg = document.getElementById('ampelRingChart'); svg.innerHTML = ''; const centerX = 250, centerY = 250; const colors = { ok: '#27AE60', fehlerhaft: '#E74C3C' }; const totalProducts = greenProducts + redProducts; const greenPercent = totalProducts > 0 ? (greenProducts / totalProducts) * 100 : 0; const startAngle = -Math.PI / 2; const greenAngle = startAngle + (greenPercent / 100) * 2 * Math.PI; const tooltip = createTooltip(); svg.parentElement.appendChild(tooltip); const centerTexts = ['Siemens-', 'Produkte', totalProducts.toString()]; const centerRadius = calculateCenterCircleRadius(centerTexts, 65); const ringThickness = 35; const innerRadius = centerRadius + 10, outerRadius = innerRadius + ringThickness; createRingSegment(svg, centerX, centerY, innerRadius, outerRadius, startAngle, greenAngle, colors.ok, `Datenaktualität passt: ${greenProducts} (${greenPercent.toFixed(1)}%)`, tooltip); createRingSegment(svg, centerX, centerY, innerRadius, outerRadius, greenAngle, startAngle + 2 * Math.PI, colors.fehlerhaft, `Datenaktualität fehlerhaft: ${redProducts} (${(100 - greenPercent).toFixed(1)}%)`, tooltip); createCentralCircle(svg, centerX, centerY, centerRadius, totalProducts, 'Produkte'); }
    function createRingSegment(svg, centerX, centerY, innerRadius, outerRadius, startAngle, endAngle, color, tooltipText, tooltip) { const path = document.createElementNS('http://www.w3.org/2000/svg', 'path'); const x1 = centerX + innerRadius * Math.cos(startAngle), y1 = centerY + innerRadius * Math.sin(startAngle); const x2 = centerX + outerRadius * Math.cos(startAngle), y2 = centerY + outerRadius * Math.sin(startAngle); const x3 = centerX + outerRadius * Math.cos(endAngle), y3 = centerY + outerRadius * Math.sin(endAngle); const x4 = centerX + innerRadius * Math.cos(endAngle), y4 = centerY + innerRadius * Math.sin(endAngle); const largeArcFlag = endAngle - startAngle <= Math.PI ? '0' : '1'; const pathData = [`M ${x1} ${y1}`, `L ${x2} ${y2}`, `A ${outerRadius} ${outerRadius} 0 ${largeArcFlag} 1 ${x3} ${y3}`, `L ${x4} ${y4}`, `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x1} ${y1}`, 'Z'].join(' '); path.setAttribute('d', pathData); path.setAttribute('fill', color); path.setAttribute('class', 'ring-segment'); path.addEventListener('mouseenter', (e) => showTooltip(tooltip, e, tooltipText)); path.addEventListener('mouseleave', () => hideTooltip(tooltip)); path.addEventListener('mousemove', (e) => updateTooltipPosition(tooltip, e)); svg.appendChild(path); }
    function createCentralCircle(svg, centerX, centerY, radius, value, unit = 'Datensätze') { const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); circle.setAttribute('cx', centerX); circle.setAttribute('cy', centerY); circle.setAttribute('r', radius); circle.setAttribute('fill', '#f8f9fa'); circle.setAttribute('stroke', '#dee2e6'); circle.setAttribute('stroke-width', '2'); svg.appendChild(circle); if (unit === 'Produkte') { const line1Text = document.createElementNS('http://www.w3.org/2000/svg', 'text'); line1Text.setAttribute('x', centerX); line1Text.setAttribute('y', centerY - 8); line1Text.setAttribute('class', 'center-text center-text-title'); line1Text.textContent = 'Siemens-'; svg.appendChild(line1Text); const line2Text = document.createElementNS('http://www.w3.org/2000/svg', 'text'); line2Text.setAttribute('x', centerX); line2Text.setAttribute('y', centerY + 8); line2Text.setAttribute('class', 'center-text center-text-title'); line2Text.textContent = 'Produkte'; svg.appendChild(line2Text); const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); valueText.setAttribute('x', centerX); valueText.setAttribute('y', centerY + 25); valueText.setAttribute('class', 'center-text center-text-value'); valueText.textContent = value; svg.appendChild(valueText); } else { const titleText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); titleText.setAttribute('x', centerX); titleText.setAttribute('y', centerY - 5); titleText.setAttribute('class', 'center-text center-text-title'); titleText.textContent = 'Gesamtdatensätze*'; svg.appendChild(titleText); const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); valueText.setAttribute('x', centerX); valueText.setAttribute('y', centerY + 20); valueText.setAttribute('class', 'center-text center-text-value'); valueText.textContent = value; svg.appendChild(valueText); } }
    function createTooltip() { const tooltip = document.createElement('div'); tooltip.className = 'chart-tooltip'; return tooltip; }
    function calculateCenterCircleRadius(texts, maxRadius = 100) { const fontSize = 10, charWidth = fontSize * 0.6, lineHeight = fontSize * 1.2; let maxTextWidth = 0; texts.forEach(text => { const textWidth = text.toString().length * charWidth; if (textWidth > maxTextWidth) maxTextWidth = textWidth; }); const padding = 10; const requiredRadius = Math.max(maxTextWidth / 2 + padding, texts.length * lineHeight / 2 + padding); return Math.min(requiredRadius, maxRadius); }
    function showTooltip(tooltip, event, text) { tooltip.textContent = text; tooltip.style.opacity = '1'; updateTooltipPosition(tooltip, event); }
    function hideTooltip(tooltip) { tooltip.style.opacity = '0'; }
    function updateTooltipPosition(tooltip, event) { const rect = event.target.closest('svg').getBoundingClientRect(); tooltip.style.left = (event.clientX - rect.left + 10) + 'px'; tooltip.style.top = (event.clientY - rect.top - 10) + 'px'; }
    function createConcentricLegend(stats) { const legendContainer = document.getElementById('concentricLegend'); const siemensPercent = stats.totalDataSets > 0 ? ((stats.totalSiemens / stats.totalDataSets) * 100).toFixed(1) : 0; const webFoundPercent = stats.searchedValues > 0 ? ((stats.foundWebValues / stats.searchedValues) * 100).toFixed(1) : 0; const matchesPercent = stats.foundWebValues > 0 ? (stats.green / stats.foundWebValues) * 100 : 0; legendContainer.innerHTML = `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; font-size: 12px;"><div><strong>Ring 1: Hersteller</strong><div class="legend-item"><div class="legend-color" style="background-color: #4A90E2;"></div><span>Siemens: ${stats.totalSiemens} (${siemensPercent}%)</span></div><div class="legend-item"><div class="legend-color" style="background-color: #E5E7EB;"></div><span>Andere: ${stats.totalDataSets - stats.totalSiemens} (${(100 - siemensPercent).toFixed(1)}%)</span></div></div><div><strong>Ring 2: Web-Suche*</strong><div class="legend-item"><div class="legend-color" style="background-color: #27AE60;"></div><span>Gefunden: ${stats.foundWebValues} (${webFoundPercent}%)</span></div><div class="legend-item"><div class="legend-color" style="background-color: #E74C3C;"></div><span>Fehlend: ${stats.searchedValues - stats.foundWebValues} (${(100 - webFoundPercent).toFixed(1)}%)</span></div></div><div><strong>Ring 3: Vergleich</strong><div class="legend-item"><div class="legend-color" style="background-color: #2ECC71;"></div><span>Gleich: ${stats.green} (${matchesPercent.toFixed(1)}%)</span></div><div class="legend-item"><div class="legend-color" style="background-color: #C0392B;"></div><span>Ungleich: ${stats.red} (${(100 - matchesPercent).toFixed(1)}%)</span></div></div></div><div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; line-height: 1.4;"><strong>*Hinweis:</strong> Für jedes Siemens-Produkt werden 8 Attribute im Web geprüft (z.B. Materialkurztext, Art.-Nr., Gewicht, etc.).<br>Die Suche bezieht sich auf diese ${stats.searchedValues} Einzelabfragen bei ${stats.totalSiemens} Produkten.</div>`; }
    function createAmpelRingLegend(greenProducts, redProducts) { const legendContainer = document.getElementById('ampelRingLegend'); const totalProducts = greenProducts + redProducts; const greenPercent = totalProducts > 0 ? ((greenProducts / totalProducts) * 100).toFixed(1) : 0; legendContainer.innerHTML = `<div class="legend-item"><div class="legend-color" style="background-color: #27AE60;"></div><span>Daten aktuell: ${greenProducts} (${greenPercent}%)</span></div><div class="legend-item"><div class="legend-color" style="background-color: #E74C3C;"></div><span>Daten fehlerhaft: ${redProducts} (${(100 - greenPercent).toFixed(1)}%)</span></div>`; }

    /* ==================== DROP ZONE ==================== */
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', () => { dropzone.classList.remove('dragover'); });
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('dragover'); if (e.dataTransfer.files?.length) { handleFile(e.dataTransfer.files[0]); } });
    fileInput.addEventListener('change', e => { if (e.target.files?.length) { handleFile(e.target.files[0]); } });

    function handleFile(file) {
      if (!/\.(xlsx|xls)$/i.test(file.name)) {
        statusEl.textContent = 'Bitte nur .xlsx oder .xls Dateien!';
        return;
      }
      resetAllStates();
      selectedFile = file;
      dzText.innerHTML = `<strong>${file.name}</strong><br><span class="hint">Datei bereit. Bitte wählen Sie eine Aktion.</span>`;
      actionChoices.style.display = 'flex';
      qualityCheckBtn.disabled = false;
      webSearchBtn.disabled = false;
      statusEl.textContent = 'Datei hochgeladen — Bitte wählen Sie eine Aktion.';
    }

    /* ==================== QUALITY CHECK ==================== */
    qualityCheckBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      // CHANGED: Simplified layout logic
      actionChoices.classList.add('stacked');

      qualityBlob = null;
      webSearchBtn.disabled = true;
      statusEl.textContent = 'Qualitätsprüfung läuft...';
      showProgress(true);
      updateProgress(20);

      try {
        const form = new FormData();
        form.append('file', selectedFile);
        const resp = await fetch('/api/check-completeness', { method: 'POST', body: form });
        if (!resp.ok) { throw new Error(`HTTP ${resp.status}: ${await resp.text()}`); }
        updateProgress(70);
        const buf = await resp.arrayBuffer();
        qualityBlob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const statsForm = new FormData();
        statsForm.append('file', new File([qualityBlob], 'Qualitätsbericht.xlsx'));
        const statsResp = await fetch('/api/quality-stats', { method: 'POST', body: statsForm });
        if (statsResp.ok) {
          const stats = await statsResp.json();
          qualityStats = stats;
          createQualityChart(stats.complete, stats.incomplete, stats.total);
          qualityCharts.classList.remove('hidden');
        } else {
          createQualityChart(0, 0, 0);
          qualityCharts.classList.remove('hidden');
        }
        updateProgress(100);
        statusEl.textContent = 'Qualitätsprüfung abgeschlossen.';
        qualityCheckBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg> Prüfung fertig`;
        qualityCheckBtn.disabled = true;
        downloadQualityBtn.classList.remove('secondary');
        downloadQualityBtn.classList.add('success');
        downloadQualityBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = 'Fehler bei Qualitätsprüfung: ' + err.message;
        console.error(err);
      } finally {
        setTimeout(() => showProgress(false), 1200);
        webSearchBtn.disabled = false;
      }
    });

    /* ==================== WEB SEARCH ==================== */
    webSearchBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      // CHANGED: Simplified layout logic
      actionChoices.classList.add('stacked');

      webProcessedBlob = null;
      qualityCheckBtn.disabled = true;
      statusEl.textContent = 'Web-Suche läuft. Dies kann einige Minuten dauern...';
      showProgress(true);
      updateProgress(10);

      try {
        const form = new FormData();
        form.append('file', selectedFile);
        if (qualityStats && qualityStats.total) {
          form.append('totalFromQuality', qualityStats.total);
        }
        const resp = await fetch('/api/process-excel-siemens', { method: 'POST', body: form });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        updateProgress(50);
        const buf = await resp.arrayBuffer();
        webProcessedBlob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const statsForm = new FormData();
        statsForm.append('file', new File([webProcessedBlob], 'Web_Vergleich_Ergebnis.xlsx'));
        const statsResp = await fetch('/api/web-search-stats', { method: 'POST', body: statsForm });
        if (statsResp.ok) {
          const stats = await statsResp.json();
          createWebCharts(stats);
          webCharts.classList.remove('hidden');
        } else {
          createWebCharts({ totalDataSets: 0, totalSiemens: 0, searchedValues: 0, foundWebValues: 0, green: 0, red: 0, ampelGreen: 0, ampelRed: 0 });
          webCharts.classList.remove('hidden');
        }
        updateProgress(100);
        statusEl.textContent = 'Web-Suche abgeschlossen.';
        webSearchBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg> Suche fertig`;
        webSearchBtn.disabled = true;
        downloadWebBtn.classList.remove('secondary');
        downloadWebBtn.classList.add('success');
        downloadWebBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = 'Fehler bei Web-Suche: ' + err.message;
        console.error(err);
      } finally {
        setTimeout(() => showProgress(false), 1200);
        qualityCheckBtn.disabled = false;
      }
    });

    /* ==================== DOWNLOADS ==================== */
    downloadWebBtn.addEventListener('click', () => { if (!webProcessedBlob) return; downloadBlob(webProcessedBlob, 'Web_Vergleich_Siemens.xlsx'); });
    downloadQualityBtn.addEventListener('click', () => { if (!qualityBlob) return; downloadBlob(qualityBlob, 'Qualitätsbericht.xlsx'); });
    function downloadBlob(blob, filename) { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.style.display = 'none'; document.body.append(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); }
  </script>
</body>
</html>
